FROM python:3.9.7-slim

RUN pip install -U pip

WORKDIR /home

COPY . .

RUN pip install -r requirements.txt

ARG RAW_DATASET_NAME
ARG RAW_DATASET_PATH
ARG PROCESSED_DATASET_NAME
ARG TARGET_COLUMN
ARG DROP_COLUMNS
ARG MLFLOW_TRACKING_URI
ARG EXPERIMENT_NAME
ARG DBNAME
ARG MYSQL_USERNAME
ARG MYSQL_PASSWORD
ARG HOSTNAME
ARG PREFECT_KEY
ARG WORKSPACE
ARG AWS_ACCESS_KEY_ID
ARG AWS_SECRET_ACCESS_KEY

# Set environment variables in the Docker image
ENV RAW_DATASET_NAME=${RAW_DATASET_NAME}
ENV RAW_DATASET_PATH=${RAW_DATASET_PATH}
ENV PROCESSED_DATASET_NAME=${PROCESSED_DATASET_NAME}
ENV TARGET_COLUMN=${TARGET_COLUMN}
ENV DROP_COLUMNS=${DROP_COLUMNS}
ENV MLFLOW_TRACKING_URI=${MLFLOW_TRACKING_URI}
ENV EXPERIMENT_NAME=${EXPERIMENT_NAME}
ENV DBNAME=${DBNAME}
ENV MYSQL_USERNAME=${MYSQL_USERNAME}
ENV MYSQL_PASSWORD=${MYSQL_PASSWORD}
ENV HOSTNAME=${HOSTNAME}
ENV PREFECT_KEY=${PREFECT_KEY}
ENV WORKSPACE=${WORKSPACE}
ENV AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
ENV AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}

RUN prefect cloud login --key $PREFECT_KEY --workspace $WORKSPACE

ENTRYPOINT [ "python", "deployment_flow.py" ]
